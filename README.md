# Drop5 — Ephemeral File Sharing Service

**Drop5**는 **OS가 서로 다른 개인 기기 간**의 번거로운 파일 전송 문제를 **로그인 없이** 5자리 코드로 즉시 해결해 주는 일회성 공유 서비스입니다. 특히 공용 PC에서도 계정 유출 걱정 없이 안전하게 사용할 수 있으며, 모든 파일은 5분 후 영구적으로 자동 삭제됩니다.

🌐 **공식 웹사이트**: [Drop5.net](https://drop5.net)

---

## 📖 사용 방법

1. **파일공유 세션 시작**
   - 브라우저에서 서버 주소(예: `https://drop5.net`)로 접속하면 고유한 5자리 세션 코드가 포함된 페이지로 자동 이동합니다.
   - **맞춤형 세션 코드 (보안 강화)**: 보안을 위해 더 길고 복잡한 코드를 사용하고 싶다면, 주소창에 직접 원하는 문자열을 입력하여 접속할 수 있습니다 (예: `/My-Secure-Vault-123456789`).
2. **파일 업로드**
   - 화면 좌측의 **구름 아이콘(☁️)** 영역으로 파일을 드래그 앤 드롭하거나 영역을 클릭하여 선택합니다.
   - **텍스트 공유**: 우측 하단의 **메모 아이콘(📝)**을 사용하여 텍스트 내용을 즉시 파일로 공유할 수 있습니다.
3. **링크 공유 및 기기 승인**
   - 우측 상단 **세션 코드**를 클릭하여 링크를 복사해 공유하고자 하는 기기에 전달합니다.
   - 새로운 기기가 접속할 경우, 기존에 접속한 기기(호스트)의 **승인**이 있어야만 접근이 가능합니다.
4. **관리 및 삭제**
   - 각 파일은 5분 후 자동 삭제되며, 더 이상 공유할 필요가 없다면 **쓰레기통 아이콘**으로 즉시 삭제도 가능합니다.

---

## 🚀 주요 특징

### ⚡ 실시간 사용자 경험
- **실시간 상태 동기화**: AJAX 폴링으로 페이지 새로고침 없이 파일 목록이 실시간으로 동기화됩니다.
- **카운트다운 타이머**: 파일별 남은 시간을 초 단위로 실시간 확인하고 관리할 수 있습니다.
- **다중 업로드**: 여러 파일을 동시에 드래그 앤 드롭하여 업로드하며, 진행률을 실시간으로 확인합니다.

### 🌍 글로벌 지원 (i18n)
- **60개 이상의 언어 지원**: 전 세계 사용자를 위해 한국어, 영어, 일본어, 중국어 등 64개국 언어를 지원합니다.
- **자동 언어 감지**: 사용자의 IP 주소(RIR 데이터 기반) 또는 브라우저 설정을 통해 최적의 언어를 자동으로 선택합니다.

### 🛠 관리 및 운영
- **휘발성 저장 (TTL)**: 설정된 시간(기본 5분)이 지나면 서버에서 데이터가 영구히 소멸됩니다.
- **NFC 한글 정규화**: Mac OS ➔ Windows/Linux 환경으로 한글 파일 전송시 자소가 분리되는 현상을 방지합니다.
- **실시간 모니터링**: `script-reporter`를 통해 서비스 상태와 치명적 오류를 Discord로 실시간 통보합니다.

### 🔐 접속 및 인프라 보안
- **2단계 접속 승인**: 새로운 기기 접속 시 기존 사용자의 승인을 거치는 호스트 승인 시스템이 적용되어 있습니다.
- **Brute Force 방지**: 1분 내 10회 이상 잘못된 코드로 접근 시 해당 IP를 1시간 동안 차단합니다.
- **보안 헤더**: XSS, Clickjacking, MIME 스니핑 방지를 위한 표준 보안 헤더가 적용되어 있습니다.

### 🛡️ 콘텐츠 보호 및 감사 정책
- **파일 확장자 차단**: 실행 파일(.exe, .sh 등) 및 잠재적 위협이 되는 확장자는 엄격히 제한합니다.
- **감사 로그(Audit Logging)**: 서비스의 안정성 확보 및 불법 행위 대응을 위한 최소한의 데이터 수집 원칙에 따라 기록됩니다.
    - **활동 유형**: 업로드, 다운로드, 세션 참여, 전체 삭제
    - **기록 항목**: 타임스탬프, 접속 IP, 세션 코드, 클라이언트 ID
    - **파기 정책**: 개인정보 보호를 위해 90일 보관 후 영구 삭제
- **지역별 이용 제한(Restricted Mode)**: 보안 리스크가 높은 지역에서 접속 시 세션당 업로드 파일 개수를 제한할 수 있습니다.

---

## 🛠 설치 및 실행

### 1. 환경 설정 및 실행
가상 환경 설정부터 실행까지 자동화된 스크립트를 제공합니다.
```bash
git clone https://github.com/yoonbae81/drop5.git
cd drop5
./scripts/setup-env.sh  # 가상 환경 및 의존성 설치
cp .env.example .env    # 환경 설정 파일 생성 (필요시 수정)
./scripts/run.sh        # 서버 실행 (Gunicorn 기반)
```

### 2. Linux 서비스 등록 (Systemd)
`install-systemd.sh` 스크립트는 메인 서비스와 RIR 업데이트 타이머를 자동으로 등록합니다.
```bash
./scripts/install-systemd.sh
```

### 3. fail2ban 연동 (보안 강화)
운영 환경(Linux)에서는 `fail2ban`을 연동하여 시스템 레벨에서 무단 접근을 강력하게 차단할 수 있습니다. `drop5`는 보안 이벤트를 감지하면 `audit/audit.log`에 `[SECURITY]` 프리픽스와 함께 로그를 남깁니다.

**1단계: 필터 설정 (`/etc/fail2ban/filter.d/drop5.conf`)**
```ini
[Definition]
failregex = ^\[SECURITY\] <HOST> - .*$
ignoreregex =
```

**2단계: 감옥 설정 (`/etc/fail2ban/jail.d/drop5.conf`)**
```ini
[drop5]
enabled = true
port    = http,https
filter  = drop5
logpath = /path/to/drop5/audit/audit.log
maxretry = 1
bantime  = 3600
findtime = 600
```

### 4. 테스트 실행
의존성이 설치된 상태에서 다음 명령어로 전체 테스트를 수행할 수 있습니다.
```bash
./.venv/bin/python3 -m unittest discover tests -v
```

---

## 📁 프로젝트 구조

```text
drop5/
├── src/
│   ├── main.py          # 메인 API 및 라우팅 로직
│   ├── session.py       # 세션 상태 및 파일 생명주기(TTL) 관리
│   ├── config.py        # 환경 변수 및 전역 설정
│   ├── middleware.py    # 보안 미들웨어 (이벤트 감지 및 로컬 캐싱)
│   ├── utils.py         # 파일 처리 및 한글 정규화 유틸리티
│   ├── audit.py         # 감사 및 보안 로그 처리 (fail2ban 연동)
│   ├── i18n/            # 다국어 지원 모듈 및 로케일 파일
│   └── views/           # 프론트엔드 (HTML/JS/CSS)
├── scripts/             # 배포 및 관리 스크립트
├── tests/               # 단위 테스트 코드
├── files/               # 임시 파일 저장소 (자동 관리)
├── security/            # 보안 설정 (차단 UA 목록 등)
└── audit/               # fail2ban이 모니터링할 로그 디렉토리
```

---

## 🔐 보안 아키텍처 (Hybrid Protection)

Drop5는 **어플리케이션 계층(L7)**의 정밀한 탐지와 **커널 계층(L3/L4)**의 효율적인 차단을 결합한 하이브리드 보호 모델을 사용합니다.

1.  **탐지 (Python Middleware)**: 실시간으로 행동(Behavioral) 분석을 수행합니다. (예: 1.5초 이내 즉시 업로드, 비정상적 요청 빈도, 금지된 User-Agent 등)
2.  **기록 (Audit Logger)**: 위반 사례가 확인되면 `audit.log`에 `[SECURITY]` 태그와 함께 IP 정보를 즉시 기록합니다.
3.  **차단 (fail2ban/OS)**: 리눅스 환경의 `fail2ban`이 로그를 감시하다가 위반 IP를 발견하는 즉시 `iptables` 또는 `nftables`를 통해 시스템 전체에서 차단합니다.
4.  **로컬 캐시**: `fail2ban`이 차단하기 전까지의 짧은 간극(Gaps)은 Python 프로세스 내부 메모리 캐시를 통해 즉각 차단하여 보호합니다.

*개발 환경(`DEBUG=true`)에서는 위 기능들이 자동으로 비활성화되어 개발 편의성을 보장합니다.*

---

## ⚙️ 상세 설정 (.env)

| 설정 항목                  | 설명                                         | 기본값              |
| :------------------------- | :------------------------------------------- | :------------------ |
| **인프라 및 환경**         |                                              |                     |
| `DEBUG`                    | 디버그 모드 활성화 (운영환경에선 false 권장) | `false`             |
| `PORT`                     | 서비스 포트                                  | `5555`              |
| `BASE_URL`                 | 접속 경로 프리픽스 (예: `/drop5`)            | `/drop5`            |
| **핵심 공유 정책**         |                                              |                     |
| `FILE_TIMEOUT`             | 파일 및 세션 유지 시간 (초)                  | `300` (5분)         |
| `MAX_FILE_SIZE`            | 개별 파일 최대 크기 (Bytes)                  | `31457280` (30MB)   |
| `MAX_STORAGE_SIZE`         | 세션당 전시 전체 파일 용량 합계 제한         | `104857600` (100MB) |
| `MAX_FILES_NORMAL`         | 일반 지역 세션당 최대 파일 개수              | `30`                |
| `MAX_FILES_RESTRICTED`     | 제한 지역 세션당 최대 파일 개수              | `5`                 |
| **저장 경로 및 지역 정책** |                                              |                     |
| `UPLOAD_DIR`               | 업로드 파일 저장 디렉토리                    | `files`             |
| `AUDIT_DIR`                | 감사 로그 저장 디렉토리                      | `audit`             |
| `RESTRICTED_COUNTRIES`     | 제한 모드를 적용할 지역 코드 목록            | `-`                 |
| **외부 연동 (옵션)**       |                                              |                     |
| `REPORTER_DISCORD_WEBHOOK` | Discord 오류 리포팅 웹후크 URL               | `-`                 |
| `UMAMI_ID`                 | Umami Analytics 추적 ID                      | `-`                 |

---

## ⚖️ 운영 원칙

### 비영리 및 프라이버시 우선
Drop5는 사용자의 프라이버시를 최우선으로 하며, 어떠한 광고나 영리적 목적 없이 운영되는 **비영리 오픈소스 프로젝트**입니다.
- **데이터 최소화**: 필요한 최소한의 데이터만 서버에 남기며, 5분 후 즉시 파기합니다.
- **투명한 코드**: 모든 로직은 공개되어 있으며 누구나 검증할 수 있습니다.
- **사용자 책임**: 불법적이거나 저작권을 침해하는 파일 공유를 금지하며, 이에 대한 모든 책임은 사용자에게 있습니다.
